<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Instalar Postgres en GCP con Replicación y Failover - Part 1</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css" rel="stylesheet">
<style>
body {
    background-color: #121212;
    color: #f0f0f0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
h1, h2, h3, h4, h5 {
    color: #ffffff;
}
hr {
    border-top: 1px solid #333;
}
.container {
    display: flex;
    justify-content: center;
}
.card {
    background-color: #1e1e1e;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.7);
    max-width: 900px;
    width: 100%;
}
pre {
    position: relative;
    background-color: #272822;
    color: #f8f8f2;
    padding: 2.5rem 1rem 1rem 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin-bottom: 1rem;
    font-family: "Fira Code", "Courier New", monospace;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}
pre::-webkit-scrollbar {
    height: 10px;
}
pre::-webkit-scrollbar-track {
    background: #1e1e1e;
    border-radius: 5px;
}
pre::-webkit-scrollbar-thumb {
    background: #0dcaf0;
    border-radius: 5px;
}
pre::-webkit-scrollbar-thumb:hover {
    background: #00bcd4;
}
.copy-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #0dcaf0;
    border: none;
    color: #000;
    padding: 3px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    z-index: 10;
}
p, li {
    color: #e0e0e0;
}
ul li {
    margin-bottom: 0.5rem;
}
a {
    color: #0dcaf0;
    text-decoration: none;
}
a:hover {
    text-decoration: underline;
}
</style>
</head>
<body>
<div class="container py-4">
  <div class="card">
    <header class="mb-4 text-center">
        <h1>Instalar Postgres en GCP con Replicación y Failover - Part 1</h1>
        <p>Aprende a instalar y configurar PostgreSQL manualmente en Google Cloud Platform</p>
        <hr>
    </header>

    <main>
    <article class="post">

      <p>Lo primero que debemos tener es la cuenta creada con Google que nos entregue un crédito inicial de 300 dólares, dar de alta una tarjeta de crédito válida. Este paso es requerido por Google; no se harán cargos al terminar los créditos que nos entrega, en lugar de eso, nuestros servicios se detendrán.</p>

      <p>Vamos a utilizar Compute Engine para esto, no utilizaremos el servicio administrado Cloud SQL. Crearemos dos instancias en Compute Engine, cambiando el sistema operativo a Ubuntu 20.04 LTS y dejando el resto por defecto.</p>

      <p>Los nombres de las máquinas virtuales pueden ser <strong>master y slave</strong>, <strong>node1 y node2</strong>, o <strong>primary y replication</strong>. En mi caso las nombré como <strong>pg-master</strong> y <strong>pg-slave</strong>.</p>

      <h4>Instalación de PostgreSQL</h4>
      <p>Ingresamos a cada instancia mediante SSH, cambiamos a root y ejecutamos:</p>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy Code</button><code class="language-bash">sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt-get update
sudo apt-get -y install postgresql-13</code></pre>

      <p>Verificar instalación:</p>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy Code</button><code class="language-bash">systemctl status postgresql
ps -feq | grep postgresql</code></pre>

      <h4>Pruebas iniciales en PostgreSQL</h4>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy Code</button><code class="language-bash">sudo -i
su - postgres
psql -l
psql -d postgres
\dt+
\q</code></pre>

      <p>Crear base de datos de prueba en <strong>pg-master</strong>:</p>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy Code</button><code class="language-bash">su - postgres
psql
create database demo;
\q
psql -d demo
create table test (int serial);
insert into test (select generate_series(1,1000));
select count(*) from test;
\q</code></pre>

      <h4>Archivos de configuración de Postgres</h4>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy Code</button><code class="language-bash">psql
SHOW config_file;
SHOW data_directory;
SHOW hba_file;</code></pre>

      <h4>Configuración de replicación en pg-master</h4>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy Code</button><code class="language-bash">sudo -i
su - postgres
psql -U postgres -c 'SHOW config_file'
exit
vi /etc/postgresql/13/main/postgresql.conf
listen_addresses = '*'
wal_level = replica
synchronous_commit = off
max_wal_senders = 10
synchronous_standby_names = '*'
vi /etc/postgresql/13/main/pg_hba.conf
host    replication     rep_user        10.128.0.0/24           md5
su - postgres
createuser --replication -P rep_user
exit
systemctl restart postgresql</code></pre>

      <h4>Configuración de pg-slave</h4>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy Code</button><code class="language-bash">sudo -i
systemctl stop postgresql
rm -rf /var/lib/postgresql/13/main/*
su - postgres
pg_basebackup -R -h 10.128.0.10 -U rep_user -D /var/lib/postgresql/13/main -P
exit
vi /etc/postgresql/13/main/postgresql.conf
listen_addresses = '*'
hot_standby = on
systemctl start postgresql</code></pre>

      <h4>Prueba de replicación</h4>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy Code</button><code class="language-bash"># En pg-master
sudo -i
su - postgres
psql -d demo
insert into test (select generate_series(1,1000));
select count(*) from test;

# En pg-slave
sudo -i
su - postgres
psql -d demo
select count(*) from test;</code></pre>

      <p>El nodo <strong>pg-slave</strong> funciona como <em>hot_standby</em>, permitiendo consultas de solo lectura y replicando automáticamente los cambios de pg-master.</p>

      <p>Para alta disponibilidad, se recomienda ubicar las máquinas en diferentes zonas o regiones y configurar adecuadamente las reglas de firewall de Google Cloud.</p>

      <hr>
      <h3>Conclusión</h3>
      <p>Hasta aquí la Part 1. En el siguiente artículo revisaremos los temas de failover y roles de las instancias.</p>

    </article>
    </main>

    <footer class="mt-5 text-center">
      <hr>
      <p>&copy; 2025 Starling Apps</p>
    </footer>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
<script>
function copyCode(btn) {
    const code = btn.nextElementSibling.textContent;
    navigator.clipboard.writeText(code).then(() => {
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy Code'; }, 1500);
    });
}
</script>

</body>
</html>
